
# Linux Driver Development

This repository contains the Raspbian distro and example drivers. The examples
are taken from the book "Linux Driver Development for Embedded Processors" by
Alberto Liberal de los Rios.

## Format the SD card and flash and image

The first step to start the linux kernel and driver development in the Raspberry PI
is to format the SD Card. To do that use the app `SD Card Formatter`.

For more details check:

https://www.raspberrypi.org/documentation/installation/sdxc_formatting.md

After the SD Card is formatted, we need to install an image. Download the Raspbian
image from:

https://www.raspberrypi.org/downloads/raspbian/

Then, download `balenaEtcher` to flash the image into the SD card.

For more details check:

https://www.raspberrypi.org/documentation/installation/installing-images/README.md


## Links to download, install and build the kernel

https://www.raspberrypi.org/documentation/linux/kernel/

https://www.raspberrypi.org/documentation/linux/kernel/building.md

## Commands to clean files generated by the build

```shell
make clean
make mrproper
```

## Commands to commit changes using git

```shell
git status
git add myfile.c 
git commit -m "description"
git push -u origin master
```

## Commands to build and install the kernel 

For all the configuration commands see https://www.raspberrypi.org/documentation/linux/kernel/building.md

```shell
cd linux-kernel
KERNEL=kernel7
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcm2709_defconfig
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage -j 4 modules dtbs

echo "Removing the mnt directory and creating a new one"
sudo rm -rf mnt
sudo mkdir mnt
sudo mkdir mnt/fat32
sudo mkdir mnt/ext4

# Mount the fat32 and ext4 filesystems (run lsblk to see the filesystem)
echo "Mounting partitions"
lsblk
sudo mount /dev/sdb1 mnt/fat32
sudo mount /dev/sdb2 mnt/ext4

# Install modules
echo "Installing modules"
sudo make ARCH=arm INSTALL_MOD_PATH=mnt/ext4 modules_install

# Copy the kernel and Device Tree blobs onto the SD card,
echo "Copying the kernel and Device Tree blobs"
sudo cp mnt/fat32/$KERNEL.img mnt/fat32/$KERNEL-backup.img
sudo cp arch/arm/boot/zImage mnt/fat32/$KERNEL.img
sudo cp arch/arm/boot/dts/*.dtb mnt/fat32/
sudo cp arch/arm/boot/dts/overlays/*.dtb* mnt/fat32/overlays/
sudo cp arch/arm/boot/dts/overlays/README mnt/fat32/overlays/
echo "Unmounting files"
sudo umount mnt/fat32
sudo umount mnt/ext4






